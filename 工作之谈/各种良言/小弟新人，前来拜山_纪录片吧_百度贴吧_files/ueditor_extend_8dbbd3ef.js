(function(c){var b={modelFactories:{},layerFactories:{},registerModel:function(e,d){this.modelFactories[e]=d},getModel:function(e){var d=this.modelFactories[e];if(d){return d.call(this,PosterContext.getContext(),PosterContext.getAuthorities())}else{throw"No such model factory: "+e}},registerLayer:function(e,d){this.layerFactories[e]=d},bindLayer:function(f,e){var d=this.layerFactories[f];if(d){return d.call(this,e,PosterContext.getContext(),PosterContext.getAuthorities())}else{throw"No such layer factory: "+f}}};var a=function(){};a.prototype={data:{},eventPool:$({}),getButton:function(){return this.$button},setButton:function(d){this.$button=d},getWidget:function(){return this.$widget},setWidget:function(d){this.$widget=d},setValue:function(d,e){this.data[d]=e},getValue:function(d){return this.data[d]},bind:function(){this.eventPool.bind.apply(this.eventPool,arguments)},trigger:function(){this.eventPool.trigger.call(this.eventPool,arguments[0],Array.prototype.slice.call(arguments,1))}};b.EditorModel=a;b.resizeImage=function(d,e){if(d.width>e){d.height=d.height/d.width*e;d.width=e}else{d.height=d.height;d.width=d.width}d.onload=null};c.EditorUI=b})(window);;UE.plugins.extendcontent=function(){var c=this;var a=c.getExtendContent&&c.getExtendContent;c.getExtendContent=function(){return a?a():{}};var b=c.getContent;c.getContent=function(){var d=b.call(this);return d.replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/(^(<br\/>)+)|((<br\/>)+$)/g,"")};c.addListener("focus",function(){c.$body.addClass("body-container-focus")});c.addListener("blur",function(){c.$body.removeClass("body-container-focus")})};UE.plugins.basicrules=function(){var a=this;a.addOutputRule(function(b){$.each(b.getNodesByTagName("p"),function(c,d){d.tagName="br"});$.each(b.getNodesByTagName("span"),function(d,e){var c=e.getAttr("class");if(c==null||!$.inArray(c,["edit_font_color","edit_font_normal","at"])){e.setAttr();e.setAttr("class","edit_font_normal")}})},true)};UE.plugins.eduilastbtn=function(){var a=this;a.ready(function(){$("#tb_rich_poster_container").find(".edui-btn").filter(function(b){return $(this).css("display")!="none"}).last().addClass("edui-last-btn")})};;UE.plugins.autolink=function(){var a=function(c){var e=String.prototype.split,d=/()??/.exec("")[1]===c,b;b=function(n,k,j){if(Object.prototype.toString.call(k)!=="[object RegExp]"){return e.call(n,k,j)}var h=[],i=(k.ignoreCase?"i":"")+(k.multiline?"m":"")+(k.extended?"x":"")+(k.sticky?"y":""),f=0,k=new RegExp(k.source,i+"g"),g,l,m,o;n+="";if(!d){g=new RegExp("^"+k.source+"$(?!\\s)",i)}j=j===c?-1>>>0:j>>>0;while(l=k.exec(n)){m=l.index+l[0].length;if(m>f){h.push(n.slice(f,l.index));if(!d&&l.length>1){l[0].replace(g,function(){for(var p=1;p<arguments.length-2;p++){if(arguments[p]===c){l[p]=c}}})}if(l.length>1&&l.index<n.length){Array.prototype.push.apply(h,l.slice(1))}o=l[0].length;f=m;if(h.length>=j){break}}if(k.lastIndex===l.index){k.lastIndex++}}if(f===n.length){if(o||!k.test("")){h.push("")}}else{h.push(n.slice(f))}return h.length>j?h.slice(0,j):h};String.prototype.split=function(g,f){return b(this,g,f)};return b}();this.addOutputRule(function(h){$.each(h.getNodesByTagName("a"),function(i,l){var n=l.innerText();if(!/^http:\/\//.test(n)){n="http://"+n}l.setAttr("href",n);l.setAttr("target","_blank")});var g=[];h.traversal(function(i){if(i.type=="text"&&i.parentNode.tagName!="a"){g.push(i)}});for(var b=0,c;c=g[b];b++){var o=c.getData().replace(/&#39;/g,"'").replace(/&quot;/g,'"');var m=a(o,/((?:www\.|http:\/\/|mms:\/\/|rtsp:\/\/|ftp:\/\/|https:\/\/)[0-9a-zA-Z;\.\!\~\#\?\:\/\&\%\-\+\*\=\@\_\$]+)/gi);if(m.length>1){var k=c.parentNode;for(var f=0,d=m.length;f<d;f++){var e=m[f];if(e.length>0){var j;if(f%2==0){j=UE.uNode.createText(e)}else{j=UE.uNode.createElement("a");if(/^http:\/\//.test(e)){j.setAttr("href",e)}else{j.setAttr("href","http://"+e)}j.setAttr("target","_blank");j.innerText(e)}k.insertBefore(j,c)}}k.removeChild(c)}}$.each(h.getNodesByTagName("a"),function(n,l){l.setAttr("href",UE.utils.unhtml(l.getAttr("href")))})},true)};;EditorUI.registerLayer("image",function(a,b,f){var c=['<ul class="layer_btn_list clearfix">','<li class="from_upload" ><a class="pic_upload_container" href="javascript: void(0);"></a><a href="#"></a></li>','<li class="from_album"><a href="#"></a></li>','<li class="from_web"><a href="#"></a></li>',"</ul>"].join("");var e='<div class="layer_text_tip">\u63d2\u5165\u56fe\u7247\u5df2\u8fbe\u4e0a\u9650\uff0c\u6700\u591a\u53ef\u63d2\u5165#{maxLimit}\u5f20~</div>';var d=$.eduipopup().on("beforeshow",function(){var g=a.getValue("maxLimit")-a.getValue("imageNumber");var h=null;if(g>0){h=$(c);h.find(".from_album > a").click(function(j){j.preventDefault();_.Module.use("common/component/PictureAlbumSelector",{maxLimit:g},function(k){k.bind("ok",function(m,l){a.trigger("insertimage",l)})})});h.find(".from_web > a").click(function(j){j.preventDefault();_.Module.use("common/component/PictureWebSelector",{maxLimit:g},function(k){k.bind("ok",function(m,l){a.trigger("insertimage",l)})})})}else{h=$($.tb.format(e,{maxLimit:a.getValue("maxLimit")}))}var i=d.edui().getBodyContainer();i.html("");i.append(h)}).on("aftershow",function(){var g=a.getValue("maxLimit")-a.getValue("imageNumber");if(g>0){_.Module.use("common/component/PictureUploader",{uploadButtonContainer:d.edui().getBodyContainer().find(".pic_upload_container"),maxLimit:g,forumId:b.forum.id},function(h){h.bind("ok",function(j,i){a.trigger("insertimage",i)});h.bind("open",function(){a.setValue("pictureUploaderOpen",true)});h.bind("close",function(){a.setValue("pictureUploaderOpen",false);a.trigger("close")})})}});a.setWidget(d);return d});;EditorUI.registerModel("image",function(b,d){var a=new EditorUI.EditorModel();EditorUI.bindLayer("image",a);var c=$.eduibutton({icon:"image",title:"\u63d2\u5165\u56fe\u7247"});a.setButton(c);a.setValue("maxLimit",d.img_num);return a});;UE.plugins.tb_image=function(){var b=this;var d=560;function a(h){var f=[];for(var e=0,g;g=h[e];e++){f.push(c(g))}return f.join("")}function c(e){if(e.width&&e.width>d){e.height=Math.floor(e.height/e.width*d);e.width=d}if(e.width&&e.height){e.size='width="'+e.width+'" height="'+e.height+'"'}else{e.size='onload="EditorUI.resizeImage(this, '+d+')"'}if(e.picType!=null){e.picType='pic_type="'+e.picType+'"'}else{e.picType=""}return $.tb.format('<img class="BDE_Image" src="#{url}" unselectable="on" #{picType} #{size} /><br />',e)}b.addListener("beforepaste",function(i,g,f){var h=/(?:<img.*?>)|(?:<emb.*?>)|(?:http:\/\/((?:[a-zA-Z\d\-]+\.)+[a-zA-Z\d]+(?:\:[\d]{2,5})?)\/([^\s]+?)\.(jpg|jpeg|gif|png|bmp))/gi;g.html=g.html.replace(h,function(e){if(e.charAt(0)=="<"){return e}else{return c({url:e,picType:1})}})});b.getImageNumber=function(){return $(b.body).find(".BDE_Image").size()};b.commands.insertimage={execCommand:function(f,g){var e=a(g);b.execCommand("inserthtml",e,true)}};b.addOutputRule(function(e){$.each(e.getNodesByTagName("img"),function(f,g){g.setAttr("onload","");var h=g.getAttr("src");if(/^data:/.test(h)){g.parentNode.removeChild(g)}})},true)};;UE.registerUI("image",function(c){var a=this;var b=EditorUI.getModel(c);var d=b.getButton();var e=b.getWidget();d.click(function(){b.setValue("imageNumber",a.getImageNumber());if(!e.parent().length){a.$container.find(".edui-dialog-container").append(e)}e.css("zIndex",a.options.zIndex+1).edui().show(d,{offsetTop:-10,caretLeft:20,caretTop:-8});$.stats.track("picture_btn","ueditor")});b.bind("insertimage",function(f,g){a.execCommand("insertimage",g)});b.bind("close",function(){e.hide()});d.edui().register("click",d,function(){var f=b.getValue("pictureUploaderOpen");if(f==null||f==false){e.hide()}});return d});;UE.plugins.video=function(){var d=this;function b(f){f.title=f.title||f.swf_url;f.vsrc=f.html_url;f.url=decodeURI(f.html_url);if(f.url.toLowerCase().indexOf("baidu.com")>-1){f.width=480;f.height=410}else{if(f.url.toLowerCase().indexOf("player.video.qiyi.com")>-1){f.width=500;f.height=415}else{f.width=500;f.height=450}}var h='<img unselectable="on" class="BDE_Flash" src="/tb/static-common/editor_img/flash.png" data-video_url="#{url}" data-vsrc="#{vsrc}" data-pkey="#{pkey}" data-vpic="#{vpic}" title="#{title}" width="219" height="175" data-width="#{width}" data-height="#{height}"'+(f.html5!="null"?' data-html5_url="#{html5}"':"")+"><br/>";var g=$.tb.format(h,f);return g}function e(f){return f.replace(/<img[^>]*class="?(?:BDE_Flash|BDE_Music)[^>]*>/gi,function(q){var h=q.replace(/.* title\="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&"),i=q.replace(/.* data\-width\="?([^\s">]+).*/i,"$1"),p=q.replace(/.* data\-height\="?([^\s">]+).*/i,"$1"),n=q.replace(/.* class="?([^\s">]+).*/i,"$1"),g="",j="",l='<embed allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" scale="noborder"'+(h.toLowerCase().indexOf("http://player.ku6.com")==0?' flashvars="adss=0"':" ")+'src="'+h+'"  class="'+n+'" width="'+i+'" height="'+p+'" ';if(n=="BDE_Flash"){g=q.replace(/.* data-video_url="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");j=q.match(/.* data-html5_url="?([^\s">]+).*/i);if(j){j=j[1].replace(/&amp;/gi,"&");l+=' vhsrc="'+j+'"'}var k=q.replace(/.* data-vsrc="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");var m=q.replace(/.* data-pkey="?([^\s">]+).*/i,"$1");var o=q.replace(/.* data-vpic="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");if(m!="null"&&m.length<40){l+=' vsrc="'+k+'"';if(o!="null"){l+=' vpic="'+o+'"'}l+=' pkey="'+m+'"'}}l+=" ><br/>";return l})}function c(f,g){UE.utils.each(f.getNodesByTagName("img"),function(i){if(i.getAttr("class")=="BDE_Flash"){if(g){var h=e(i.toHtml());i.parentNode.replaceChild(UE.uNode.createElement(h),i)}}})}d.addOutputRule(function(f){c(f,true)},true);d.addInputRule(function(f){c(f,false)});d.getVideoNumber=function(){return $(d.body).find(".BDE_Flash").size()};d.hasLocalVideo=function(){return $(d.body).find(".BDE_Flash").filter(function(f){var g=$(this).data("pkey");return g!=null&&g!=""&&g.substr(0,5)=="pkey_"}).size()>0};d.getVideoUrl=function(){var f=$(d.body).find(".BDE_Flash");return f.size()>0?f.data("vsrc"):null};d.getFileId=function(){var f=d.getVideoUrl();var g=d.hasLocalVideo();return g&&f.length>0?f.substr(5):""};d.commands.insertvideo={execCommand:function(l,j){j=UE.utils.isArray(j)?j:[j];var h=[];for(var g=0,k,f=j.length;g<f;g++){k=j[g];h.push(b(k))}d.execCommand("inserthtml",h.join(""),true)},queryCommandState:function(){var g=d.selection.getRange().getClosedNode();var f=g&&(g.className=="BDE_Video");return f?1:0}};d.addListener("aftergetcontent",function(g,f){UE.utils.each(f.getNodesByTagName("embed"),function(h){if(h.getAttr("class")=="BDE_Flash"){h.setAttr("src",h.getAttr("src").replace(/&amp;/g,"&"));var i=h.getAttr("vsrc");if(i){h.setAttr("vsrc",i.replace(/&amp;/g,"&"))}}})});var a=d.getExtendContent&&d.getExtendContent;d.getExtendContent=function(){var f={videoNumber:d.getVideoNumber(),hasLocalVideo:d.hasLocalVideo(),videoUrl:d.getVideoUrl(),fileId:d.getFileId()};return $.extend(a?a():{},f)}};;EditorUI.registerLayer("video",function(a,b,f){var c={can_local_upload:'<div class="j_video_container video_container"><div class="v_layer_content j_content"><ul class="v_ul clearfix"><li class="v_url_btn" ><a href="#" onclick="return false;" class="v_url_bg"></a></li><li class="v_local_btn"><a a href="#" onclick="return false;"  class="v_url_container" ></a><a href="#" onclick="return false;" class="v_local_bg" ></a></li></ul></div></div>',normal:['<div class="j_video_container video_container"><div class="v_layer_content j_content">','<div style="padding:30px 0px 5px 30px" class="clearfix"><input type="text" class="v_layer_input ui_textfield j_input" value="\u8bf7\u76f4\u63a5\u8f93\u5165\u89c6\u9891\u64ad\u653e\u9875\u5730\u5740"  ><a href="#" style="float:left;margin-left:5px;" class="ui_btn ui_btn_m j_btn"><span><em>\u63d2\u5165\u89c6\u9891</em></span></a></div>','<div  class="j_error_tip v_error_tip" style="display:none;padding-left:30px;line-height:22px;"></div>','<div style="color:#999;line-height:22px;padding-left:30px;" class="v_layer_text j_layer_text">\u76ee\u524d\u652f\u6301\u7231\u5947\u827a\u3001\u4f18\u9177\u3001\u571f\u8c46\u3001\u641c\u72d0\u3001\u817e\u8baf\u3001\u4e50\u89c6\u7b49\u89c6\u9891\u7f51\u7ad9\u94fe\u63a5</div>',"</div></div>"].join("")};var e=f.can_local_upload;var d=$.eduipopup().on("beforeshow",function(){var h=d.edui().getBodyContainer();var g=$(e?c.can_local_upload:c.normal);h.html("");h.append(g);if(a.getValue("UeditorVideo")){a.getValue("UeditorVideo").init(g)}else{_.Module.use("common/component/UeditorVideo",[{container:g,CAN_LOCAL_UPLOAD:e}],function(i){a.setValue("UeditorVideo",i);i.bind("insertvideo",function(k,j){a.trigger("insertvideo",j)})})}}).on("afterhide",function(){var g=a.getValue("UeditorVideo");g&&g.trigger("closelocalvideo")});a.setWidget(d);return d});;EditorUI.registerModel("video",function(b,d){var a=new EditorUI.EditorModel();EditorUI.bindLayer("video",a);var c=$.eduibutton({icon:"video",title:"\u63d2\u5165\u89c6\u9891"});a.setButton(c);return a});;UE.registerUI("video",function(c){var a=this;var b=EditorUI.getModel(c);var d=b.getButton();var e=b.getWidget();d.click(function(f){if(!e.parent().length){a.$container.find(".edui-dialog-container").append(e)}if(e.css("display")==="none"){e.css("zIndex",a.options.zIndex+1).edui().show(d,{offsetTop:-10,offsetLeft:85,caretLeft:105,caretTop:-8})}else{e.edui().hide()}$.stats.track("video_btn","ueditor")});e.edui().register("click",e,function(f){if(d[0]!==f.target&&!$.contains(d[0],f.target)){e.edui().hide()}});b.bind("insertvideo",function(g,f){a.execCommand("insertvideo",f);e.edui().hide()});return b.getButton()});;UE.plugins.music=function(){var e=this;function b(g,i){var j='<img unselectable="on" class="BDE_Music" title="#{url}" src="/tb/static-common/img/rich_editor/music.png" width="112" height="31" data-width="400" data-height="95" /><br/>';g.url="http://box.baidu.com/widget/flash/bdspacesong.swf?from=tieba&url=&name=&artist=&song_id="+g.song_id+"&extra=&autoPlay=false&loop=true";g.url=encodeURI(g.url);var h=[(i&&g.title&&g.artist)?$.tb.format("<p>#{title} - #{artist}</p>",g):"",$.tb.format(j,g)].join("");return h}function f(g){return g.replace(/<img[^>]*class="?(?:BDE_Flash|BDE_Music)[^>]*>/gi,function(r){var i=r.replace(/.* title\="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&"),j=r.replace(/.* data\-width\="?([^\s">]+).*/i,"$1"),q=r.replace(/.* data\-height\="?([^\s">]+).*/i,"$1"),o=r.replace(/.* class="?([^\s">]+).*/i,"$1"),h="",k="",m='<embed allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" scale="noborder"'+(i.toLowerCase().indexOf("http://player.ku6.com")==0?' flashvars="adss=0"':" ")+'src="'+i+'"  class="'+o+'" width="'+j+'" height="'+q+'" ';if(o=="BDE_Flash"){h=r.replace(/.* data-video_url="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");k=r.match(/.* data-html5_url="?([^\s">]+).*/i);if(k){k=k[1].replace(/&amp;/gi,"&");m+=' vhsrc="'+k+'"'}var l=r.replace(/.* data-vsrc="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");var n=r.replace(/.* data-pkey="?([^\s">]+).*/i,"$1");var p=r.replace(/.* data-vpic="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");if(n!="null"&&n.length<40){m+=' vsrc="'+l+'"';if(p!="null"){m+=' vpic="'+p+'"'}m+=' pkey="'+n+'"'}}m+=" ><br/>";return m})}function d(g,i,h){UE.utils.each(g.getNodesByTagName("img"),function(l){if(l.getAttr("class")=="BDE_Music"){var j=l.getAttr("title");var k=b({song_id:c("song_id",j),title:c("name",j),artist:c("artist",j)});if(i){k=f(k)}l.parentNode.replaceChild(UE.uNode.createElement(k),l)}})}function c(h,g){g=decodeURI(g);return decodeURIComponent((new RegExp(h+"=([^&]+?)($|&)").exec(g)||[undefined,""])[1])}e.addOutputRule(function(g){d(g,true,false)},true);e.addInputRule(function(g){d(g,false,false)});e.getMusicNumber=function(){return $(e.body).find(".BDE_Music").size()};e.commands.insertmusic={execCommand:function(l,k){k=UE.utils.isArray(k)?k:[k];var j=[];for(var h=0,m,g=k.length;h<g;h++){m=k[h];j.push(b(m,true))}e.execCommand("inserthtml",j.join(""),true)},queryCommandState:function(){var h=e.selection.getRange().getClosedNode();var g=h&&(h.className=="BDE_Music");return g?1:0}};var a=e.getExtendContent&&e.getExtendContent;e.getExtendContent=function(){var g={musicNumber:e.getMusicNumber()};return $.extend(a?a():{},g)}};;EditorUI.registerModel("music",function(b,e){var c=$.eduibutton({icon:"music",title:"\u63d2\u5165\u97f3\u4e50"});var a=new EditorUI.EditorModel();a.setButton(c);var d=e.music_num;c.on("click",function(){if(a.getValue("UeditorMusic")){a.trigger("showdialog")}else{_.Module.use("common/component/UeditorMusic",[{MAX_MUSIC_NUM:d}],function(f){a.setValue("UeditorMusic",f);a.bind("showdialog",function(){f.trigger("showdialog");a.trigger("aftershowdialog")});a.bind("updatecount",function(g,h){f.trigger("updatecount",h)});f.bind("insertmusic",function(h,g){a.trigger("insertmusic",g)});a.trigger("showdialog")})}$.stats.track("music_btn","ueditor")});return a});;UE.registerUI("music",function(b){var c=this;var a=EditorUI.getModel(b);var d=a.getButton();a.bind("insertmusic",function(g,f){c.execCommand("insertmusic",f);a.trigger("updatecount",c.getMusicNumber())});a.bind("aftershowdialog",function(f){a.trigger("updatecount",c.getMusicNumber())});return a.getButton()});;EditorUI.registerLayer("emotion",function(b,c,f){var d='<div class="j_emotion_container emotion_container"></div>';var a=$(d);var e=$.eduipopup().on("beforeshow",function(){if(!b.getValue("UeditorEmotion")){var g=e.edui().getBodyContainer();g.html("");g.append(a);_.Module.use("common/component/UeditorEmotion",[{container:a}],function(h){b.setValue("UeditorEmotion",h);h.bind("insertemotion",function(j,i){b.trigger("insertemotion",i)})})}if($.browser.msie&&$.browser.version==6){$("#tb_rich_poster").find(".j_sign_id").hide()}});if($.browser.msie&&$.browser.version==6){e.on("afterhide",function(){$("#tb_rich_poster").find(".j_sign_id").show()})}b.setWidget(e);return e});;EditorUI.registerModel("emotion",function(b,d){var a=new EditorUI.EditorModel();EditorUI.bindLayer("emotion",a);var c=$.eduibutton({icon:"emotion",title:"\u63d2\u5165\u8868\u60c5"});a.setButton(c);return a});;UE.registerUI("emotion",function(c){var a=this;var b=EditorUI.getModel(c);var d=b.getButton();var e=b.getWidget();d.click(function(f){if(!e.parent().length){a.$container.find(".edui-dialog-container").append(e)}e.css("zIndex",a.options.zIndex+1).edui().show(d,{offsetTop:-10,offsetLeft:225,caretLeft:247,caretTop:-8});$.stats.track("emotion_btn","ueditor")});e.edui().register("click",e,function(f){if(d[0]!==f.target&&!$.contains(d[0],f.target)){e.edui().hide()}});b.bind("insertemotion",function(i,f){var h='<img unselectable="on" pic_type="" class="BDE_Smiley" src="#{url}">';var g=f.type==="text"?f.title:$.tb.format(h,f);a.execCommand("inserthtml",g);e.hide()});return d});;EditorUI.registerLayer("scrawl",function(b,c,f){var d='<div style="padding:10px;">\u54a6\uff0c\u6b64\u529f\u80fd\u9700\u8981\u62e5\u6709\u672c\u54276\u7ea7\u5934\u8854\u624d\u80fd\u4f7f\u7528\uff0c\u518d\u52aa\u529b\u4e00\u4e0b\uff01&nbsp;<a href="http://tieba.baidu.com/f/like/level?kw=#{name}#level_main" target="_blank">\u67e5\u770b\u5347\u7ea7\u79d8\u7c4d</a></div>';var a=null;b.bind("show",function(){if(c.user.level>=6){_.Module.use("common/component/Scrawl",{forumName:c.forum.name,userName:c.user.name},function(g){a=g;g.bind("ok",function(h,i){b.trigger("insertscrawl",i)})})}});if(c.user.level<6){var e=$.eduipopup().on("beforeshow",function(){var g=e.edui().getBodyContainer();g.html($.tb.format(d,c.forum))});b.setWidget(e)}});;EditorUI.registerModel("scrawl",function(b,d){var a=new EditorUI.EditorModel();EditorUI.bindLayer("scrawl",a);var c=$.eduibutton({icon:"scrawl",title:""});a.setButton(c);return a});;UE.registerUI("scrawl",function(c){var a=this;var d=this;var b=EditorUI.getModel(c);var e=b.getButton();var f=b.getWidget();e.click(function(){b.trigger("show");if(f){if(!f.parent().length){a.$container.find(".edui-dialog-container").append(f)}f.css("zIndex",a.options.zIndex+1).edui().show(e,{offsetTop:-10,caretLeft:20,caretTop:-8})}$.stats.track("scrawl_btn","ueditor")});e.edui().register("click",e,function(){f&&f.hide()});b.bind("insertscrawl",function(g,h){d.execCommand("insertimage",[{url:h,picType:5,width:416,height:335}])});return e});;UE.plugins.attachment=function(){this.attachments=[];this.addAttachment=function(b){this.attachments.push(b)};this.removeAttachment=function(c){if(c.md5){for(var b=0,d;d=this.attachments[b];b++){if(d.path===c.path){this.attachments.splice(b,1);break}}}};var a=this.getExtendContent;this.getExtendContent=function(){var b=a.call(this);b.attachments=$.json.encode(this.attachments);return b}};;EditorUI.registerLayer("attachment",function(e,b,h){var c=5;function g(j){j=parseInt(j);if(j<1024){return j+"byte"}var k=(j/1024).toFixed(2);if(k<1024){return k+"KB"}var l=(k/1024).toFixed(2);if(l<1024){return l+"MB"}return(l/1024).toFixed(2)+"GB"}var i='<div class="attachment_layer"><div class="attachment_btn_container"><button style="display: none;">\u4e0a\u4f20\u6587\u4ef6</button><span>\u6b63\u5728\u8fde\u63a5\u767e\u5ea6\u4e91\uff0c\u8bf7\u7a0d\u5019...</span><div class="attachment_flash_container"></div></div>\u8fd8\u80fd\u4e0a\u4f20<em id="attachmentNumberCount" class="j_number_count"></em>\u4e2a\u9644\u4ef6\uff0c\u6bcf\u4e2a\u9644\u4ef6\u5c0f\u4e8e<em>'+(h.attachment_size/1024/1024)+'</em><br/>\u9644\u4ef6\u5c06\u540c\u6b65\u5230\u767e\u5ea6\u4e91\u7f51\u76d8\uff0c\u60a8\u7684\u5269\u4f59\u7a7a\u95f4\uff1a<em class="j_pan_unused"></em> <a href="http://pan.baidu.com/" target="_blank">\u6574\u7406\u7f51\u76d8</a></div>';var d="<div style='padding: 15px'>\u54a6\uff0c\u6b64\u529f\u80fd\u9700\u8981\u62e5\u6709\u672c\u54275\u7ea7\u5934\u8854\u624d\u80fd\u4f7f\u7528\uff0c\u518d\u52aa\u529b\u4e00\u4e0b\uff01 <a href='http://tieba.baidu.com/f/like/level?kw="+b.forum.name+"#level_main' target='_blank'>\u67e5\u770b\u5347\u7ea7\u79d8\u7c4d</a></div>";var f=null;var a=$.eduipopup({stopprop:true}).on("beforeshow",function(){var j=a.edui().getBodyContainer();j.html("");if(b.user.level>=c){f=$(i);f.find(".j_number_count").text(h.attachment_num-e.getValue("attachmentNumber"))}else{f=$(d)}f.click(function(k){k.stopPropagation()});j.append(f)}).on("aftershow",function(){if(b.user.level>=c){var l=f.find(".attachment_flash_container");var k=f.find("button");var j=f.find(".j_number_count");$.getJSON("http://pcs.baidu.com/rest/2.0/pcs/quota?app_id=419237&method=info&callback=?",function(n){if(n.error_code){k.next().html("\u8fde\u63a5\u5931\u8d25")}else{var m=n.quota-n.used;f.find(".j_pan_unused").text(g(m));k.show().next().hide();_.Module.use("common/component/AttachmentUploader",[{coverButton:k,container:l,UIContainer:e.getValue("attachmentContainer")},{max_length:h.attachment_num-e.getValue("attachmentNumber"),forum_id:b.forum.id,upload_size_limit:h.attachment_size,storage_capacity:m,upload_url:"http://pcs.baidu.com/rest/2.0/pcs/file?method=upload&dir=%2fapps%2ftieba&ondup=newcopy&app_id=419237"}],function(o){o.bind("file_added",function(){j.text(j.text()-1)});o.bind("upload_complete",function(q,p){e.trigger("add_attachment",p)});o.bind("remove_file",function(q,p){e.trigger("remove_attachment",p);j.text(j.text()-0+1)})})}})}});e.setWidget(a);return a});;EditorUI.registerModel("attachment",function(b,d){var a=new EditorUI.EditorModel();EditorUI.bindLayer("attachment",a);var c=$.eduibutton({icon:"attachment",title:"\u63d2\u5165\u9644\u4ef6"});a.setButton(c);if(b.product!="frs"){c.hide()}return a});;UE.registerUI("attachment",function(d){var b=this;var c=EditorUI.getModel(d);var e=c.getButton();var f=c.getWidget();var a=$("<div class='edui-attachment-container'></div>");b.$container.append(a);c.setValue("attachmentContainer",a);c.bind("add_attachment",function(g,h){b.addAttachment(h)});c.bind("remove_attachment",function(g,h){b.removeAttachment(h)});e.click(function(h){c.setValue("attachmentNumber",b.attachments.length);if(!f.parent().length){var g=$('<div class="edui-attachment-dialog-container"></div>');b.$container.find(".edui-toolbar").append(g);g.append(f);f.css("zIndex",b.options.zIndex+1).edui().show(e,{offsetTop:-10,offsetLeft:300,caretLeft:320,caretTop:-8})}else{f.css("left","70px")}$.stats.track("attachment_btn","ueditor")});e.edui().register("click",e,function(){f.css("left","-9999px")});return e});;EditorUI.registerModel("voice",function(b,d){var c=$.eduibutton({icon:"voice",title:"\u53d1\u8bed\u97f3"});if(b.product!="pb"){c.hide()}var a=new EditorUI.EditorModel();a.setButton(c);if($.tb.Storage.get("VoicePosterAdClosed")!=1){c.append('<span class="edui-icon-new"></span>')}c.on("click",function(){c.find(".edui-icon-new").remove();$("body").trigger("showvoicedialog",true);$.tb.Storage.set("VoicePosterAdClosed",1);$.stats.track("voice_btn","ueditor")});return a});;UE.registerUI("voice",function(c){var a=this;var d=this;var b=EditorUI.getModel(c);var e=b.getButton();var f=b.getWidget();return e});;UE.plugins.bold=function(){var a=this;a.addOutputRule(function(b){$.each(b.getNodesByTagName("b"),function(c,d){d.tagName="strong"})},true);a.commands.bold={execCommand:function(b){return this.document.execCommand(b)},queryCommandState:function(b){try{return this.document.queryCommandState(b)}catch(c){return false}}}};;EditorUI.registerModel("bold",function(b,d){var a=new EditorUI.EditorModel();var c=$.eduibutton({icon:"bold"});a.setButton(c);if(b.user.signNumber<10){c.hide()}return a});;UE.registerUI("bold",function(c){var a=this;var b=EditorUI.getModel(c);var d=b.getButton();d.click(function(){a.execCommand(c)});this.addListener("selectionchange",function(){var e=this.queryCommandState(c);d.edui().disabled(e==-1).active(e==1)});return d});;UE.plugins.red=function(){var a="#000000";var c="#e10602";function b(m){var j=/[0-9]{0,3}/g;var n=m.match(j);var o="#";var f=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];for(var h=0;h<n.length;h++){var d=null,k=n[h],g=k;var e=[];while(k>16){d=k%16;k=(k/16)>>0;e.push(f[d])}e.push(f[k]);if(g<16&&g!=""){e.push(0)}o+=e.reverse().join("")}return o}this.addOutputRule(function(d){$.each(d.getNodesByTagName("span"),function(f,g){var e=g.getStyle("color");if(e){g.setAttr();if(e.indexOf("rgb")!=-1){e=b(e)}if(e==a){g.setAttr("class","edit_font_normal")}else{g.setAttr("class","edit_font_color")}}});$.each(d.getNodesByTagName("font"),function(f,e){e.setAttr();e.tagName="span";e.setAttr("class","edit_font_color")})},true);UE.commands.red={execCommand:function(){var f;if(this.queryCommandState("red")){f=a}else{f=c}var d=this.selection.getRange();if(d.collapsed){var e=$("<span></span>")[0];e.style.color=f;d.insertNode(e).setStart(e,0).setCursor()}else{this.document.execCommand("forecolor",false,f)}},queryCommandState:function(d){var f=this.selection.getStart();var e=$(f).css("color");if(e.indexOf("rgb")!=-1){e=b(e)}if(e.toLowerCase()==c){return 1}else{return 0}}}};;EditorUI.registerModel("red",function(b,d){var a=new EditorUI.EditorModel();var c=$.eduibutton({icon:"red"});a.setButton(c);if(b.user.signNumber<20){c.hide()}return a});;UE.registerUI("red",function(c){var a=this;var b=EditorUI.getModel(c);var d=b.getButton();d.click(function(){a.execCommand("red")});this.addListener("selectionchange",function(){var e=this.queryCommandState("red");d.edui().disabled(e==-1).active(e==1)});return d});;UE.plugins.height_limit=function(){var d=$(window).height()-200;var b=false;var a=this;this.addListener("contentchange afterinserthtml keyup mouseup",function(){c()});this.ready(function(){a.$container.on("restored.draft",function(){setTimeout(c,1000)})});function c(){var e=a.$body.height();if(!b&&e>d){a.$body.css({height:d});b=true}else{if(b&&e==a.$body[0].scrollHeight){a.$body.css({height:"auto"});b=false}}}};;UE.plugins.draft=function(){var a=this;if($.tb.Storage.isSupport()){var c=PosterContext.getContext();var b=["draft",c.user.id,c.forum.id,c.thread?c.thread.id:0].join("-");var d=$.tb.throttle(function(e,f){$.tb.Storage.set(e,f);a.$container.trigger("saved.draft")},2000);this.addListener("contentchange",function(){d(b,this.body.innerHTML)});this.restoreDraft=function(){var e=$.tb.Storage.get(b);if(e&&e!="<p><br></p>"&&e!="<P>&nbsp;</P>"){this.body.innerHTML=e;this.$container.trigger("restored.draft")}};this.clearDraft=function(){$.tb.Storage.remove(b)}}else{this.clearDraft=function(){}}};;UE.plugins.counter=function(){var b=this;function a(c){return c.replace(/[^\x00-\xff]/g,"mm").length}b.getContentByteLength=function(){return a(b.getContent())}};;UE.plugins.at=function(){var d=this;function a(e,g){var f=this;this.$root=$("<div class='edui_at_box' style='display: none;'><div class='at_box_title'>\u60f3\u7528@\u63d0\u5230\u8c01\uff1f</div><ul></ul></div>").appendTo(e);this.$list=this.$root.children("ul");this.$list.on({mouseenter:function(){f.setFocus(this)},click:function(){var h=$(this).text();f.hide();g(h)}},"li");this.shown=false}a.prototype={loadSuggestion:function(f){var e=this;$.get("/at-sug",{query:f,uid:PosterContext.getContext().user.id,ie:"utf-8"},function(g){if(g.error==0){var k=[];for(var j=0,h;h=g.msg[j];j++){k.push("<li>");k.push(h);k.push("</li>")}e.$list.html("").append(k.join(""))}},"json")},clearList:function(){this.$list.html("")},isShown:function(e){if(e){return this.shown&&this.target==e}else{return this.shown}},show:function(f){if(f!=this.target){this.clearList()}this.target=f;this.shown=true;var e=$(f).position();this.$root.css({left:e.left,top:e.top+16}).show()},hide:function(){this.$root.hide();this.shown=false},first:function(){this.setFocus(this.$list.children(":first"))},last:function(){this.setFocus(this.$list.children(":last"))},next:function(){var e=this.$list.children(".focus");if(e.size()==0){this.first()}else{if(e.index()==(this.$list.children().size()-1)){this.first()}else{this.setFocus(e.next())}}},prev:function(){var e=this.$list.children(".focus");if(e.size()==0){this.last()}else{if(e.index()==0){this.last()}else{this.setFocus(e.prev())}}},setFocus:function(e){$(e).siblings(".focus").removeClass("focus").end().addClass("focus")},getValue:function(){return this.$list.find(".focus").text()}};function c(f){var e=f.selection.getRange();if(e.collapsed){var g=$("<span class='at'>@</span>")[0];e.setStart(e.startContainer,e.startOffset-1).select().deleteContents().insertNode(g).setStart(g,1).collapse(true).select();f.atBox.show(g)}}function b(f){var e=d.selection.getRange();var h=d.selection.getStart();var g=UE.dom.domUtils.findParent(h,function(i){return $(i).is(".at")&&i.tagName=="SPAN"},true);if(g&&f!=null&&f.length>0){g.innerHTML="@"+f+""}e.setStartAfter(g).collapse(true).select();d.execCommand("inserthtml","&nbsp;")}d.addListener("ready",function(){d.atBox=new a(d.$body.parent(),b)});d.addListener("keydown",function(e,f){if(d.atBox.isShown()){switch(f.keyCode){case 38:d.atBox.prev();break;case 40:d.atBox.next();break;case 13:var g=d.atBox.getValue();d.atBox.hide();b(g);break;case 32:b(null);break;default:return}if(f.preventDefault){f.preventDefault()}return false}});d.addListener("keyup",function(e,f){if(f.keyCode==50&&f.shiftKey){c(this)}else{if(this.atBox.isShown()&&$.inArray(f.keyCode,[38,40,13,32])==-1){var h=UE.dom.domUtils.findParent(this.selection.getStart(),function(i){return i.className=="at"},true);var g=$(h).text().substring(1);if(g.length>0){this.atBox.loadSuggestion(g)}}}});d.addListener("selectionchange",function(){var e=d.selection.getRange();if(e.collapsed){var g=d.selection.getStart();var f=UE.dom.domUtils.findParent(g,function(h){return h.className=="at"},true);if(f){if(!this.atBox.isShown(f)){this.atBox.show(f);this.atBox.loadSuggestion($(f).text().substring(1))}}else{this.atBox.isShown()&&this.atBox.hide()}}});this.addOutputRule(function(e){$.each(e.getNodesByTagName("span"),function(g,j){var f=j.getAttr("class");if(f=="at"){var k=j.innerText();var h=UE.uNode.createText(k);var i=j.parentNode;i.insertBefore(h,j);i.removeChild(j)}})},true)};;UE.plugins.baiduinput=function(){var a=this;var b={};b.initialPlugin=function(){this.timer=null;var c=document.createElement("div");c.id="bdInputObjWrapper";document.getElementById("tb_rich_poster").appendChild(c);if(UE.browser.ie){document.getElementById("bdInputObjWrapper").innerHTML='<object id="BdInputAx" classid="CLSID:D64016F6-4D8E-4B35-AB22-9B2060800112" width="0" height="0"></object>'}else{if(!UE.browser.gecko){document.getElementById("bdInputObjWrapper").innerHTML='<object id="BdInputAx" type="application/baiducnff-activex" progid="BaiducnAx.ScreenShotAx.1" width="0" height="0"></object>'}}this.bdInputObj=document.getElementById("BdInputAx");if(this.bdInputObj&&"GetNewSession" in this.bdInputObj){this.supportBdInput=true;this.bdInputObj.StartReadFileFuncName="bdInputRead";window.bdInputSession=0;window.bdInputPasting=false;window.bdInputUploader=null;window.bdInputTbs="";$.getJSON("http://tieba.baidu.com/dc/common/imgtbs",function(e){var d={};if(e.no==0){d.uploadUrl="http://upload.tieba.baidu.com/upload/pic?tbs="+e.data.tbs}_.Module.use("common/component/image_uploader_manager",[d],function(f){bdInputUploader=f})});window.bdInputShowError=function(d){clearTimeout(window.bdInputErrorTimer);_postor._errorTipShow(d);window.bdInputErrorTimer=setTimeout(function(){_postor._errorTipHide()},2000)};window.bdInputUploadCallback=function(e){var d,f;if(e.errorCode!=0){window.bdInputShowError("\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}else{if(e.response.error_code!=0){window.bdInputShowError("\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}d=e.response.info.pic_id_encode;f="http://imgsrc.baidu.com/forum/pic/item/"+d+".jpg";a.execCommand("insertimage",[{url:f}])}};window.bdInputInsertImg=function(d){if(!window.bdInputUploader){_.Module.use("common/component/image_uploader_manager",[],function(e){bdInputUploader=e;bdInputUploader.uploadBase64(d,bdInputUploadCallback)})}else{bdInputUploader.uploadBase64(d,bdInputUploadCallback)}};window.bdInputRead=function(){var h,l,k,g="",f=[],e=0,j=0;h=document.getElementById("BdInputAx");l=h.GetFileCount(bdInputSession);if(l==0){return}for(var d=0;d<l;d++){k=h.GetFileRange(bdInputSession,d);if(k>4194304){e++;continue}g=h.GetFileMem(bdInputSession,d,0,k);window.bdInputInsertImg(g)}h.EndSceenShotParse(bdInputSession);if(e){bdInputShowError("\u526a\u8d34\u677f\u4e2d\u6709"+e+"\u5f20\u6587\u4ef6\u8fc7\u5927\uff0c\u4f7f\u7528\u56fe\u7247\u4e0a\u4f20\u8bd5\u8bd5\u5427~")}}}else{this.supportBdInput=false}};a.baiduInput=b;b.initialPlugin();if(b.supportBdInput){a.addListener("beforepaste",function(f,d,c){if(c.firstChild()){if(b.timer){clearTimeout(b.timer);b.timer=null}b.defaultPaste=true}});a.addListener("afterpaste",function(d,c){b.defaultPaste=false});UE.dom.domUtils.on(document.body,UE.browser.ie||UE.browser.opera?"keydown":"paste",function(c){if((UE.browser.ie||UE.browser.opera)&&((!c.ctrlKey&&!c.metaKey)||c.keyCode!="86")){return}if(b.supportBdInput&&!b.defaultPaste){if(b.timer!=null){clearTimeout(b.timer);b.timer=null}b.timer=setTimeout(function(){bdInputSession=b.bdInputObj.GetNewSession();b.bdInputObj.StartScreenShotParse(bdInputSession)},400)}else{b.defaultPaste=false}})}};;EditorUI.registerModel("screenshot",function(b,g){var a=new EditorUI.EditorModel();var c=null;try{c="baidubrowser.tieba"==window.external.GetVersion("version")?true:null}catch(f){c=null}if(c){var d=$.eduibutton({icon:"screenshot",title:"\u622a\u56fe"});a.setButton(d);d.click(function(j){var h=$.ajax({url:"http://tieba.baidu.com/dc/common/imgtbs",dataType:"json"});var i=window.external.GetNextReqID("id");if(!window.screenShot){window.screenShot=function(e,k){k=k&&$.parseJSON(k);if(e==e&&k&&k.result!="error"&&k.content&&k.content.url){a.trigger("insertscreenshot",{url:k.content.url})}}}h.done(function(k){if(k.no==0){try{window.external.StartRequest(i,"bdbrowser.extension.tiebacmdToLibEx","screenShot",'{"cmd":"PageSnapStart","fid":"'+b.forum.id+'","tbs":"'+k.data.tbs+'"}',window,"")}catch(l){}}});$.stats.track("screenshot_btn","ueditor")})}return a});;UE.registerUI("screenshot",function(b){var c=this;var a=EditorUI.getModel(b);a.bind("insertscreenshot",function(f,d){c.execCommand("insertimage",[d])});return a.getButton()});;