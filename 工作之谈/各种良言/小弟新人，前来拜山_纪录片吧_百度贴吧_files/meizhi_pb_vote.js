_.Module.define({path:"pb/component/meizhi_pb_vote",requires:["common/component/Card"],sub:{_dlg:null,_map:{meizhi:{type:"\u59b9\u7eb8",reply:"\u597d\u6f02\u4eae\u7684\u59b9\u7eb8\uff0c\u6211\u9876\u4f60\uff01"},weiniang:{type:"\u4f2a\u5a18",reply:"\u65e9\u5c31\u8ba4\u8bc6\u4f60\uff0c\u4f60\u662f\u771f\u4f2a\u5a18\uff01"},renyao:{type:"\u4eba\u5996",reply:"\u5c11\u88c5\u4e86\uff0c\u6211\u5728\u6cf0\u56fd\u89c1\u8fc7\u4f60\uff01"}},initial:function(){var a=this;this._wrap=$("#meizhi_pb");this._vote_btn_group=this._wrap.find(".j_vote_btn_group").delegate(".j_vote_btn","click",function(){var b=$(this).getData();a._user_id=b.user_id;a._vote_type=b.vote_type;a.vote()});this.bindTipEvent()},bindTipEvent:function(){var a=this;var b=["<p>\u5df2\u767b\u9646\u7528\u6237\u6240\u6295\u7684\u7968\u4e3a\u6709\u6548\u7968</p>","<p>\u672a\u767b\u9646\u7528\u6237\u6240\u6295\u7684\u7968\u4e3a\u706b\u661f\u7968</p>"].join("");this._wrap.delegate(".j_vote_tip","mouseenter",function(){var h=this;var d=$(h);var c=parseInt(d.css("paddingLeft"))+parseInt(d.css("marginLeft"));var g=d.offset().left-178/2+(d.width()+c)/2;var f=d.offset().top+8+12;a._tip_card=a.use("common/component/Card",{content:b,arrow_pos:{left:79},arrow_dir:"up",card_css:{top:f,left:g,width:178,height:58},card_hover_show:false,attr:" id='meizhi_vote_tip' ",wrap:$("body")});a._tip_card.showCard()});this._wrap.delegate(".j_vote_tip","mouseleave",function(){a._tip_card.closeCard()})},vote:function(){var c=this;var a="/encourage/post/meizhi/checkvcode";var b="/encourage/post/meizhi/getvcode";_.Module.use("common/component/PostorServiceMeizhi",[],function(d){d.postHandler({data:{content:"",tbs:PageData.tbs,fid:PageData.forum.id,kw:PageData.forum.name,uid:c._user_id,scid:PageData.user.id||0,vtype:c._vote_type,ie:"utf-8",vcode:""},url:"/encourage/post/meizhi/vote",type:"vote",checkUrl:a,vCodeUrl:b,success:function(f){var g=f;var e=c.buildDlg(g);c.buildVoteResult(g);c.showVoteResult();c.showDlg(e)}})})},_msgDialog:function(){var a={image:'<img style="border:none;" src="http://static.tieba.baidu.com/tb/img/messageFace.gif">',subMessage:"\u6295\u7968\u6210\u529f",message:"",dialogSet:{width:410,height:50,title:"\u53d1\u8d77\u6295\u7968"}};var b='<div style="margin: 0px 30px 0px 30px;font-size:14px;line-height:20px;text-align:left;font-family: "\u5b8b\u4f53";"><table style="width:90%"><tbody><tr><td width="60">'+a.image+'</td><td valign="middle" style="font-size:20px;line-height:22px;font-family: "\u9ed1\u4f53";">'+a.subMessage+"</td></tr></tbody></table>"+a.message+"</div>";$.dialog.alert(b,a.dialogSet)},buildVoteResult:function(e){var c=e.vote_count;var g=c.meizhi+c.weiniang+c.renyao;var f=(c.meizhi/g*100).toFixed(1);var d=(c.weiniang/g*100).toFixed(1);var b=(c.renyao/g*100).toFixed(1);var a=['<div class="meizhi_vote_result">','<h1><span class="success_tip">\u6295\u7968\u6210\u529f</span></h1>','<div class="vote_result_group">','<div class="vote_result_single clearfix">','<span class="process_bar_label">\u59b9\u7eb8\uff1a</span>','<div class="process_bar_wrap">','<div class="process_bar_meizhi" style="width: '+f+'%"></div>',"</div>",'<span class="vote_percent">'+f+"%</span>",'<span class="vote_valid" title="\u6709\u6548'+c.meizhi+'\u7968">\u6709\u6548'+this.cutVoteCount(c.meizhi)+"\u7968</span>",'<span class="vote_invalid j_vote_tip">(\u706b\u661f'+this.cutVoteCount(c.meizhi_guest)+"\u7968)</span>","</div>",'<div class="vote_result_single clearfix">','<span class="process_bar_label">\u4f2a\u5a18\uff1a</span>','<div class="process_bar_wrap">','<div class="process_bar_weiniang" style="width: '+d+'%"></div>',"</div>",'<span class="vote_percent">'+d+"%</span>",'<span class="vote_valid" title="\u6709\u6548'+c.weiniang+'\u7968">\u6709\u6548'+this.cutVoteCount(c.weiniang)+"\u7968</span>",'<span class="vote_invalid j_vote_tip">(\u706b\u661f'+this.cutVoteCount(c.weiniang_guest)+"\u7968)</span>","</div>",'<div class="vote_result_single clearfix">','<span class="process_bar_label">\u4eba\u5996\uff1a</span>','<div class="process_bar_wrap">','<div class="process_bar_renyao" style="width: '+b+'%"></div>',"</div>",'<span class="vote_percent">'+b+"%</span>",'<span class="vote_valid" title="\u6709\u6548'+c.renyao+'\u7968">\u6709\u6548'+this.cutVoteCount(c.renyao)+"\u7968</span>",'<span class="vote_invalid j_vote_tip">(\u706b\u661f'+this.cutVoteCount(c.renyao_guest)+"\u7968)</span>","</div>","</div>",'<p>\u5171\u6709<span class="total_count">'+g+"</span>\u540d\u5427\u53cb\u6295\u7968</p>","</div>"].join("");this._vote_result=a},cutVoteCount:function(a){return a>999?"999+":a},buildDlg:function(f){var e=this._map[this._vote_type].type,a="",d="";var c=f.meizhi_complete_rate;if(f.levelup==1){d="\u606d\u559cTa\uff0c\u6210\u529f\u83b7\u5f97\u664b\u7ea7\uff01"}else{switch(f.next_level){case 0:a="\u6ee1\u7ea7";break;case 1:break;default:a=f.next_level-1;break}d="\u83b7\u5f97"+f.exp_value+"\u70b9\u7ecf\u9a8c\uff0c"+f.levelup_left+"\u5f20\u59b9\u7eb8\u7968\u540e\u5347\u7ea7\u5230Mvp"+a+"\uff01"}var b=['<div id="meizhi_vote_reply" class="meizhi_vote_reply">',"<h1>\u6295\u7968\u5b8c\u6210\uff01\u8981\u4e0d\u8981\u8ddfTa\u8bf4\u70b9\u4ec0\u4e48\uff1f</h1>",'<p class="process_text">\u59b9\u7eb8\u5b8c\u6210\u5ea6\uff1a</p>','<div class="meizhi_process_bar_layer clearfix">','<div class="process_bar_wrap">','<div class="process_bar_meizhi" style="width: '+c+'%"></div>',"</div>",'<span class="vote_percent">'+c+"%</span>","</div>",'<div class="vote_info_reply">'+d+"</div>",'<textarea class="ui_textfield" id="j_meizhi_reply"></textarea>','<a href="#" class="ui_btn ui_btn_m j_submit">',"<span><em>\u53d1 \u8868</em></span>","</a>","</div>"].join("");return b},showDlg:function(a){this._dlg=new $.dialog({html:a,title:"\u53d1\u8868\u56de\u590d",width:500,holderClassName:"meizhi_vote_reply_wrap"});this.bindDlgEvent()},bindDlgEvent:function(){var a=this;var c=this._map[this._vote_type].reply;var b=$("#meizhi_vote_reply");b.find(".j_submit").click(function(f){var d=b.find("#j_meizhi_reply").val()||c;d=a.parseUrl(d);a.postReply(d);f.preventDefault()});_.Module.use("common/component/Placeholder",["#j_meizhi_reply",c],function(){})},parseUrl:function(d){var b="<";var a=">";var c=4;if(d.length>c){d="."+d;d=d.replace(/([^0-9a-zA-Z])((www\.|http:\/\/|mms:\/\/|rtsp:\/\/|ftp:\/\/|https:\/\/)[0-9a-zA-Z\.\!\~\#\?\:\/\&\%\-\+\*\'\=\@\_\$]+)/gi,"$1"+b+'a href="$2" target="_blank"'+a+"$2"+b+"/a"+a);d=d.substring(1)}return d},postReply:function(b){var a=this;if(this.isLogin()){_.Module.use("common/component/PostorService",[],function(c){c.postHandler({data:{anonymous:0,content:b,tid:PageData.thread.id,fid:PageData.forum.id,ie:"utf-8",kw:PageData.forum.name,rich_text:0,lp_sub_type:0,lp_type:0,floor_num:PageData.thread.reply_num,tbs:PageData.tbs},type:"reply",success:function(d){$.tb.location.reload()}})})}},isLogin:function(){if(PageData.user.is_login){if(PageData.user.no_un){this._dlg.hide();TbCom.process("User","buildUnameFrame");return false}}else{this._dlg.hide();_.Module.use("common/component/LoginDialog",["","userBar"]);return false}return true},showVoteResult:function(){var b=this;this._vote_btn_group.remove();var a=$(this._vote_result).appendTo(this._wrap)}}});